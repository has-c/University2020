---
title: "Assignment 3 - Stats 330"
author: "Hasnain Cheena"
date: "20/05/2020"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Question 1: Heart Attacks

```{r Read Data and Lib Imports, include=FALSE}
library(VGAM)
library(MuMIn)

hearthealth.df= read.csv('hearthealth.csv')[c('age','chol', 'heartattack')]
hearthealth.df$chol <- factor(hearthealth.df$chol) #use fchol instead of chol

```



```{r Q1 - Fit}
#fit GAM
heart.gam.fit = vgam(heartattack ~ s(age) + chol, family=binomialff, data=hearthealth.df)

summary(heart.gam.fit)
```

The summary output shows us that we have no evidence against  using linear terms for the variables age and cholesterol in the model $ha.lin$. Thus the claim that $ha.lin$ is appropriate is correct.

```{r Q1 - Plot}
plot(heart.gam.fit, se=TRUE, lcol="blue", scol="red", llwd=2, slwd=2)
```
Comment: 
- Uncertainty 
- Generally linear 


Mathematical equation of the GLM:

$$ $$ 

$$ $$ 



Mathematical formula of the gAM model:

$$ logit(p_i) = \beta_0 + f_1(age_i) + \beta_2chol_i $$

$$ Y_i \sim Binomial(n,p) $$
where $age_i$ is the age in years of a patient and $chol_i$ = 1 when a patient has low cholestrol and 0 when a patient has high cholestrol. Furthermore, the response variable has binomial distribution with parameters n and p. 


## Question 2: Women's BMI

```{r Q2 - a}

#read the data in 
bmi.df = read.csv('feuro.csv')
#sort by age
bmi.df = bmi.df[order(bmi.df$age),]

#calculate BMI
bmi.df$bmi = bmi.df$weight / ((bmi.df$height)^2)


#proportion of obese people
proportions = data.frame("groups"= c("Obese", "Overweight"),
                         "proportions" = c(sum(bmi.df$bmi >= 30) * 100 /nrow(bmi.df), sum(bmi.df$bmi >= 25 & bmi.df$bmi < 30))*100/nrow(bmi.df))
  
proportions
 
```
WHO Guidelines:
https://www.who.int/news-room/fact-sheets/detail/obesity-and-overweight

Website states that:
- Obese is where the BMI is greater than or equal to 30
- Overweight is where the BMI is greater than or equal to 25

The calculations show that 0.49% of the sample is WHO classified as obese and 29.04% of the sample is classified as overweight. 

Obese = 13%
Overweight = 26%


```{r Q2 - Plot, fig.width=10, fig.height=6}
#dataset is very large so randomly select 
# set.seed(321)
index = sample(nrow(bmi.df), size=1000)
small.bmi.df = na.omit(bmi.df[index,])

#scatterplot
plot(bmi~age, small.bmi.df, main="BMI vs Age", xlab="age (years)")


```
Comment:
A random sample of 1000 datapoints were taken so that a high quality scatterplot could be produced to comment on. 

From the scatterplot it is visible that at the younger ages there is less variance in bmi than at the older ages. Bmi variance increases as age increases. Further it is clear there are more many more observations of people between the ages of 20-50 than people between 50-90. 

Trend: slightly increasing upto 60 and a slight decrease after. 


```{r Q2 - Smooth Spline,fig.width=10, fig.height=6}
#smooth spline - EDF set by GCV
bmi.spline = with(small.bmi.df,smooth.spline(age,bmi))
bmi.spline

#add to plot
plot(bmi~age, small.bmi.df, col="grey")
lines(bmi.spline, col="blue", lwd=2)
```


The equivalent degrees of freedom fit using GCV is approximately 4.8 which is reasonable. From the plot the spline seems to be a good fit (not too overfit or underfit). The trend seems to be as European woman get older their bmi tends to increases until it peaks around 62 years old. After this age it starts to decrease again. 

This trend could be because at the younger ages till around 60 people in the education system or in the workforce. This lifestyle can be sedentary (less exercise) therfore bmi increases gradually. However at around 60 years old people retire and have health issues. 

Height doesn't increase alot past 19-20 but weight continues to change. 

```{r Q2 - Smooth Spline Fitted value,  fig.width=10, fig.height=6}
predict(bmi.spline, 50)
```
We estimate for a European woman that is 50 years old, her bmi will be 25.64. 

```{r Q2 - Quadratic }
#quadratic 
bmi.quad.fit = lm(bmi~ poly(age,2), data=small.bmi.df)

age = data.frame("age"=16:87)
predictions = predict(bmi.quad.fit, age)

#fit 
#add to plot
plot(bmi~age, small.bmi.df, col="grey")
lines(bmi.spline, col="blue", lwd=2)
lines(age$age, predictions, col="red", lty=2, lwd=2)

```
The quadratic seems to be underfitting the pattern unlike the smooth spline. 

## Question 3: COVID-19

```{r Q3 - Data Cleaning}
#read in data
covid.df = read.csv('covid19nz.csv')

#replace -1 with 0
covid.df[covid.df$newcases == -1,]$newcases = 0

#create day variable
covid.df$Day = seq(1,nrow(covid.df))

#scatterplot
plot(newcases~Day, data=covid.df)

#use asDate to change string date to date and then plot as newcases vs date
```
The scatterplot shows that at lower case numbers there is less variance and at higher cases numbers there seems to be more variance. Further the spread of the data seems reasonably symmetric.


```{r Q3 - load mgcv and detach vgam}
#detach mgcv
detach(package:VGAM)

#attach mgcv
library(mgcv)
```


```{r Q3 - fit}
#fit
covid.gam.fit = gam(newcases~s(Day), data=covid.df, family=poisson)

#plot 
plot(covid.gam.fit, pages=1)

#plot scatter and the line
plot(newcases~Day, covid.df, col="grey")
lines(fitted(covid.gam.fit), col="blue")

```

From the plot of the fitted values versus the observations indicates that the GAM has fit well (not overfit or underfit the data). However it also shows that at lower case numbers (less variance in case numbers) the GAM was able to fit the data well (the tails), but as cases increased the variance in the new case numbers also increased and therefore the GAM was not able to fit the data well in this region.

- Fit well but fits tails better than peak because of high variance

```{r Q3 - quadratic, plot and AIC}
#quadratic 
covid.quad.fit = glm(newcases~ poly(Day,2), data=covid.df, family=poisson)

#add to plot
plot(newcases~Day, covid.df, col="grey")
lines(fitted(covid.gam.fit), col="blue")
lines(fitted(covid.quad.fit), col="orange")


#use AIC to compare the models
AIC(covid.gam.fit,covid.quad.fit)

```
From the plot you can see the quadratic doesnt fit the data as well. Overestimates and underestimates and estimates a later peak. 

Furthermore, the AIC score of the GAM is much lower than the quadratic. This means we have strong evidence to suggest that the GAM fits the data better than the quadratic model (parametric model).

```{r Q3 - new cases peak}
#GAM peak
covid.df$doy[which.max(covid.gam.fit$fitted.values)]

#Quadratic peak
covid.df$doy[which.max(covid.quad.fit$fitted.values)]

```
Comment:
The GAM estimates that the number of new cases peaked on the 31st of March 2020, compared to the quadratic which estimates the number of new cases peaked on the 3rd of April 2020. The true answer is the cases peaked on the 2nd and 5th of April 2020 at 89 new cases. 

There is a observable difference between both models. Quadratic model underestimated the peak by ..... amount of cases and also estimated the peak later than the GAM. The quadratic overestimates and underestimates more than the GAM. In comparision the GAM seems to be fitting the data much beter (as proven by AIC). 

Q3e: 

A number of 0's was added prior to the first case. This was for symmetry to allow us to fit a quadratic (a symmetric plot) without performing any transformations. 

Show some evidence - remove all 0's and refit to show it doesn't work without the additional 0's 
